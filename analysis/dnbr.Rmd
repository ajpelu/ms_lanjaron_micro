---
title: "Burn Severity"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## dNBR

- To compute de dNBR we used Landsat ... 

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(purrr)
library(raster)
library(kableExtra)
library(ggpubr)
library(gtsummary)
library(plotrix)
```

```{r}
f <- list.files("data/dnbr", pattern = "*.tif", full.names = TRUE)

prepRast <- function(x) {
  name_layer <- gsub(".tif", replacement = "", basename(x))
  r <- raster::raster(x)
  df <- as.data.frame(r, xy= TRUE) 
  names(df)[3] <- "dnbr"
  df <- df |> 
    filter(!is.na(dnbr)) |> 
    mutate(yd = gsub("dnbr_", replacement = "", name_layer)) |> 
    mutate(severity_effis = 
           cut(dnbr, 
               breaks = c(-Inf, 100, 255, 410, 
                              660, Inf),
               labels = c(
                 "Unburned/Very Low", "Low", "Moderate", 
                 "High", "Very High")
               ))
  
  return(df)
}

dnbr_all <- f |> purrr::map_dfr(prepRast) 

```


#### Explore fire severity
- Severity by pixels 

```{r}

dnbr_summary <- dnbr_all |> 
  dplyr::select(-x, -y) |> 
  group_by(yd, severity_effis) |> 
  tally() |>
  mutate(freq = round(prop.table(n)*100,2)) |> 
  mutate(area = n*0.09)



dnbr_summary_compare <- dnbr_summary |> 
  dplyr::select(-n, -area) |> 
  pivot_wider(names_from = yd, 
              values_from = freq)

dnbr_summary_compare_area <- dnbr_summary |> 
  dplyr::select(-n, -freq) |> 
  pivot_wider(names_from = yd, 
              values_from = area)
```


```{r}
dnbr_summary_compare |> 
  kableExtra::kbl(caption = "Percentage of severity categories using different season to compute the dNBR. yd_60_305: 01/03/2005; yd_152_305: 01/06/2005; yd_244_305: 01/09/2005") |> 
  kable_styling()  
```

```{r}
dnbr_summary_compare_area |> 
  kableExtra::kbl(caption = "Percentage of severity categories using different season to compute the dNBR. (Same of table anterior, but using area (ha))") |> 
  kable_styling()  
```



#### Severity of the sampled plot

Do the burned sample points (i.e. "LJQ.") have the same burn severity?

- For each sampling point, dNBR values were extracted (We selected yd152), both for the exact pixel of the sampling point and for the 8 neighboring pixels. 

```{r, message=FALSE, warning=FALSE}
dnbr_vecinos <- read_delim("data/ltr/dnbr_vecinos.csv", delim=";") |> 
  dplyr::rename(dnbr = dnbr_yd152) |> 
  mutate(severity_effis = 
           cut(dnbr, 
               breaks = c(-Inf, 100, 255, 410, 
                              660, Inf),
               labels = c(
                 "Unburned/Very Low", "Low", "Moderate", 
                 "High", "Very High")
               ))

```

- We compared using non-parametric Kruskal-Wallis

```{r, echo=FALSE}
my_comparisons <- 
  list(c("LJQ1", "LJQ2"), 
       c("LJQ1", "LJQ3"),
       c("LJQ2", "LJQ3"))

```

```{r}
ggpubr::ggboxplot(dnbr_vecinos, 
          x = "plot", 
          y = "dnbr", 
          add = "jitter", 
          xlab = "", 
          ylab = "dNBR") +
  ggpubr::stat_compare_means(comparisons = my_comparisons) +
  stat_compare_means(label.y = 100) 
```


```{r}
compare_means(dnbr ~ plot, dnbr_vecinos, 
              method = "wilcox.test", 
              p.adjust.method = "bonferroni") |> 
  kableExtra::kbl() %>% 
  kable_styling()
```


```{r}
dnbr_vecinos |> 
  dplyr::select(-type, -severity_effis, -dnbr_yd60) |> 
  tbl_summary(
    by = plot,
    statistic = list(
      all_continuous() ~ "{mean} Â± {std.error} ({sd})"
    ))
```


#### Map 
- This map was created using QGIS 

```{r, echo=FALSE}
knitr::include_graphics("assets/mapa_severidad_152.jpg", error = FALSE)
```

```{r, eval=FALSE, echo=FALSE}
# https://effis.jrc.ec.europa.eu/about-effis/technical-background/rapid-damage-assessment
effis_df <- 
  c(-Inf, 100, 0, 
    100, 255, 1, 
    255, 410, 2,
    410, 660, 3, 
    660, Inf, 4)
    
# 0 = "Unburned/Very Low"
# 1 = "Low"
# 2 = "Moderate"
# 3 = "High"
# 4 = "Very High"


reclass_df <- 
  c(-Inf, -251, -2,
    -251, -101, -1,  
    -101, 99, 0,  
    99, 269, 1,  
    269, 439, 2, 
    439, 659, 3,  
    659, Inf, 4)

# -2, "Regrowth High", 
# -1, "Regrowth Low",
# 0, "Unburned",
# 1, "Low Severity",
# 2, "Moderate Low Severity",
# 3, "Moderate High Severity",
# 4, "High Severity"


## See  https://www.scielo.org.mx/pdf/rca/n98/2663-3981-rca-98-145.pdf 
# https://www.sciencedirect.com/science/article/pii/S0303243420308862 
# https://polipapers.upv.es/index.php/raet/article/view/13082/13393 
# https://www.juntadeandalucia.es/medioambiente/portal_web/rediam/productos/Publicaciones/congresos/2017_XVIICongresoAET/2017_AET_Cartografia_IncendioQuesada.pdf 
# https://8cfe.congresoforestal.es/sites/default/files/actas/8CFE-1064.pdf 
# https://www.juntadeandalucia.es/medioambiente/portal/documents/20142/0/2022_10_26_TOPCART_SierraBermeja_ver5_corregida.pdf/f8092d1b-9a08-453e-4dce-c4056f8d54c8?t=1668590187164 


reclass_m <- matrix(reclass_df, 
                    ncol = 3, byrow = TRUE) 

dnbr_reclas <- raster::reclassify(dnbr, reclass_m)
plot(dnbr_reclas)

```


```{r}
dnbr_vecinos |> 
  dplyr::select(-dnbr_yd60) |> 
  kableExtra::kbl() %>% 
  kable_styling()
```




